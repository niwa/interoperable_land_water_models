# Results Aggregator

This is a bmi-compliant "model" that uses weighted sums or averages to aggregate values from a table in SQLite into a smaller number of values in another table.

The purpose of the program is to group results from small areas into larger ones -- e.g. from farms to river catchments. We anticipate that it will be used in combination with the iterator, and read the results from that program as inputs.

## User Notes

Input values, weights, and output values are all in database tables. The user must provide the input and the weights tables, and the program generates the output table. These can all be in a single SQLite file, or in separate files.

The program is governed by a YAML configuration file like this one:

```YAML
weights:
    format: sqlite
    path: .\WeightsOnly.db
    table: Weights
    aggregate_column: Zone
    entity_column: Id
    weight_column: Weight

output:
    format: sqlite
    path: .\ResultsOnly.db
    table: AveragedResults
    aggregate_column: Zone
    value_column: Average

input:
    format: sqlite
    path: .\InputsOnly.db
    table: Inputs
    entity_column: Id
    value_column: Score
```

Although the table format is configurable, only SQLite is supported.

The weighted averages are generated by this SQL:

```SQL
Insert into <output table>
Select <aggregate>,
  sum(<input value> * <weight>)/sum(<weight>)
  as <output value>
from <weights table>
inner join <inputs table> on <inputs entity> = <weights entity>
group by <aggregate>;
```

If the aggregation is done by summing instead of averaging, the SELECT part of the SQL query loses the /sum(\<weight\>) term. The aggregated quantity can also be scaled up or down with a factor also. The optional YAML to invoke SUM aggregation or scaling is shown here.

```YAML
aggregate:
    operation: SUM
    scale: 0.5
```

The resulting SQL is now:

```SQL
Insert into <output table>
Select <aggregate>,
  sum(<input value> * <weight>) * <scale>
  as <output value>
from <weights table>
inner join <inputs table> on <inputs entity> = <weights entity>
group by <aggregate>;
```

## Folder Contents

* data
  * aggregator.yaml -- a sample configuration file
  * WeightedAverage.db -- a sqlite database with three tables
    * Inputs -- numerical values one-to-one with entities
    * Weights -- entities grouped to zones with weights
    * AveragedResults -- weighted averages of inputs one-to-one with zones
  * aggregator3db.yaml -- a second sample configuration file using a separate file for each table
  * InputsOnly.db -- contains only the input table for the 3db example
  * WeightsOnly.db -- contains only the weights table for the 3db example

* src -- source code
* builds -- CMake stuff goes here

## To Do

* All existing contents of output table are deleted before the results are posted. Consider a more flexible arrangement
